// Group Planner - Prisma Schema
// This file defines the database schema using Prisma ORM

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with authentication and profile information
model User {
  // Primary key
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Authentication fields
  email        String  @unique
  username     String? @unique
  passwordHash String

  // Profile information
  displayName String?
  timezone    String? @default("UTC")

  // Account verification
  emailVerified Boolean @default(false)

  // User preferences stored as JSON
  preferences Json @default("{}")

  // Relationships
  refreshTokens     RefreshToken[]
  passwordResets    PasswordReset[]
  loginAttempts     LoginAttempt[]
  tripMembers       TripMember[]
  suggestedEvents   Event[]                  @relation("EventSuggestor")
  approvedEvents    Event[]                  @relation("EventApprover")
  createdItems      Item[]
  itemClaims        ItemClaim[]
  notifications     Notification[]
  notificationPrefs NotificationPreference[]
  announcements     Announcement[]

  @@map("users")
}

// Refresh token model for JWT authentication
model RefreshToken {
  // Primary key
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Token data
  tokenId      String    @unique
  tokenHash    String    @unique
  expiresAt    DateTime
  family       String?
  revoked      Boolean   @default(false)
  revokedAt    DateTime?
  revokeReason String?
  userAgent    String?
  ipAddress    String?

  // User relationship
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// Password reset token model
model PasswordReset {
  // Primary key
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Token data
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  // User relationship
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// Enums for trip management
enum TripStatus {
  PLANNING
  ACTIVE
  COMPLETED
  CANCELLED
}

enum MemberRole {
  HOST
  CO_HOST
  MEMBER
}

enum MemberStatus {
  PENDING
  CONFIRMED
  DECLINED
}

enum EventStatus {
  PROPOSED
  APPROVED
  CANCELLED
}

enum ItemType {
  RECOMMENDED
  SHARED
}

enum ClaimStatus {
  CLAIMED
  BROUGHT
  CANCELLED
}

// Trip model for group planning
model Trip {
  // Primary key
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Trip details
  title       String
  description String?
  status      TripStatus @default(PLANNING)

  // Location stored as JSON (flexible for different location formats)
  location Json?

  // Unique invite code for sharing the trip
  inviteCode String @unique @default(cuid())

  // Additional metadata stored as JSON
  metadata Json @default("{}")

  // Trip dates
  startDate DateTime?
  endDate   DateTime?

  // Relationships
  members           TripMember[]
  events            Event[]
  items             Item[]
  notifications     Notification[]
  notificationPrefs NotificationPreference[]
  announcements     Announcement[]
  extensions        TripExtension[]

  @@map("trips")
}

// TripMember model for managing user participation in trips
model TripMember {
  // Composite primary key
  tripId String
  userId String

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Member details
  role   MemberRole   @default(MEMBER)
  status MemberStatus @default(PENDING)

  // Additional member-specific settings
  notifications Boolean @default(true)
  canInvite     Boolean @default(false)

  // Relationships
  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([tripId, userId])
  @@map("trip_members")
}

enum DigestFrequency {
  NONE
  DAILY
  WEEKLY
}

model Notification {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  userId    String
  tripId    String?
  type      String
  title     String
  body      String?
  payload   Json      @default("{}")
  read      Boolean   @default(false)
  readAt    DateTime?

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip Trip? @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

model NotificationPreference {
  id              String          @id @default(cuid())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  userId          String
  tripId          String?
  emailEnabled    Boolean         @default(true)
  pushEnabled     Boolean         @default(true)
  scheduleChanges Boolean         @default(true)
  itemUpdates     Boolean         @default(true)
  announcements   Boolean         @default(true)
  digestFrequency DigestFrequency @default(DAILY)

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  trip Trip? @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([userId, tripId])
  @@map("notification_preferences")
}

model Event {
  id            String      @id @default(cuid())
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  tripId        String
  title         String
  description   String?
  location      Json?
  startTime     DateTime?
  endTime       DateTime?
  isAllDay      Boolean     @default(false)
  status        EventStatus @default(PROPOSED)
  category      String?
  estimatedCost Decimal?
  currency      String      @default("USD")
  suggestedById String
  approvedById  String?
  metadata      Json        @default("{}")

  trip        Trip  @relation(fields: [tripId], references: [id], onDelete: Cascade)
  suggestedBy User  @relation("EventSuggestor", fields: [suggestedById], references: [id])
  approvedBy  User? @relation("EventApprover", fields: [approvedById], references: [id])

  @@index([tripId, startTime])
  @@map("events")
}

model Item {
  id             String      @id @default(cuid())
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  tripId         String
  name           String
  description    String?
  category       String?
  type           ItemType
  quantityNeeded Int         @default(1)
  isEssential    Boolean     @default(false)
  createdById    String
  metadata       Json        @default("{}")
  claims         ItemClaim[]

  trip      Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdBy User @relation(fields: [createdById], references: [id])

  @@index([tripId, type])
  @@map("items")
}

model ItemClaim {
  id        String      @id @default(cuid())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  itemId    String
  userId    String
  quantity  Int         @default(1)
  status    ClaimStatus @default(CLAIMED)
  notes     String?

  item Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([itemId, userId])
  @@map("item_claims")
}

model Announcement {
  id        String   @id @default(cuid())
  tripId    String
  authorId  String
  title     String
  body      String
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trip   Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("announcements")
}

model TripExtension {
  id            String   @id @default(cuid())
  tripId        String
  extensionType String
  data          Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([tripId, extensionType])
  @@map("trip_extensions")
}

// Login attempt tracking for account security
model LoginAttempt {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Attempt details
  identifier String // email or username attempted
  ipAddress  String
  userAgent  String?
  success    Boolean @default(false)

  // User relationship (optional - null if user doesn't exist)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Failure details
  failureReason String? // "user_not_found", "invalid_password", "account_locked", etc.

  @@index([userId, createdAt])
  @@index([identifier, createdAt])
  @@index([ipAddress, createdAt])
  @@map("login_attempts")
}
